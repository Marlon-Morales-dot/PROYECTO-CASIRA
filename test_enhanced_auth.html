<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASIRA - Test Enhanced Auth & Storage</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.5rem;
        }
        
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1rem;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border-left: 4px solid #4285F4;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .button {
            background: linear-gradient(135deg, #4285F4, #34A853);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button.secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        
        .user-info {
            background: #fff;
            border: 2px solid #4285F4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .user-info.show {
            display: block;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            float: left;
        }
        
        .storage-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-line;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 CASIRA Enhanced Auth Test</h1>
            <p>Sistema de Almacenamiento Persistente + Google Auth Integrado</p>
        </div>

        <div class="grid">
            <!-- Google Auth Section -->
            <div>
                <div class="test-section">
                    <h3>🔐 Google Authentication</h3>
                    <div id="auth-status" class="status info">
                        <strong>Estado:</strong> Inicializando Google Auth...
                    </div>
                    
                    <div id="user-info" class="user-info">
                        <div id="user-details"></div>
                        <div style="clear: both; margin-top: 15px;">
                            <button class="button danger" onclick="signOutGoogle()">
                                🚪 Cerrar Sesión Google
                            </button>
                        </div>
                    </div>
                    
                    <button id="google-signin-btn" class="button" onclick="signInGoogle()" style="display: none;">
                        📧 Iniciar Sesión con Google
                    </button>
                </div>

                <div class="test-section">
                    <h3>👥 Gestión de Usuarios CASIRA</h3>
                    <button class="button secondary" onclick="createTestUser()">
                        ➕ Crear Usuario de Prueba
                    </button>
                    <button class="button secondary" onclick="listAllUsers()">
                        📋 Listar Usuarios
                    </button>
                    <button class="button secondary" onclick="exportUserData()">
                        📤 Exportar Datos
                    </button>
                </div>
            </div>

            <!-- Storage Section -->
            <div>
                <div class="test-section">
                    <h3>💾 Sistema de Almacenamiento</h3>
                    <button class="button secondary" onclick="showStorageStats()">
                        📊 Estadísticas de Storage
                    </button>
                    <button class="button secondary" onclick="testPersistence()">
                        🔄 Probar Persistencia
                    </button>
                    <button class="button danger" onclick="clearAllStorage()">
                        🧹 Limpiar Todo
                    </button>
                </div>

                <div class="test-section">
                    <h3>📝 Acciones de Prueba</h3>
                    <button class="button secondary" onclick="simulateActivity()">
                        🎯 Simular Actividad
                    </button>
                    <button class="button secondary" onclick="testNotifications()">
                        🔔 Test Notificaciones
                    </button>
                    <button class="button secondary" onclick="testComments()">
                        💬 Test Comentarios
                    </button>
                </div>
            </div>
        </div>

        <div id="results" class="storage-stats" style="display: none;"></div>
        
        <div id="console-output" class="storage-stats" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
            <strong>📜 Log de Consola:</strong><br>
        </div>
    </div>

    <script>
        // ============= STORAGE MANAGER SIMULADO =============
        class TestStorageManager {
            constructor() {
                this.storageKey = 'casira-test-v2';
                this.data = new Map();
                this.loadFromStorage();
                this.log('🚀 Test Storage Manager iniciado');
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        Object.keys(parsed).forEach(key => {
                            this.data.set(key, parsed[key]);
                        });
                        this.log(`📦 Datos cargados: ${Object.keys(parsed).length} colecciones`);
                    } else {
                        this.initializeDefaults();
                    }
                } catch (error) {
                    this.log(`❌ Error cargando datos: ${error.message}`, 'error');
                    this.initializeDefaults();
                }
            }

            initializeDefaults() {
                const defaults = {
                    users: [
                        {
                            id: 1,
                            email: 'admin@casira.org',
                            first_name: 'Admin',
                            last_name: 'CASIRA',
                            role: 'admin',
                            provider: 'internal'
                        }
                    ],
                    activities: [],
                    notifications: [],
                    comments: []
                };

                Object.keys(defaults).forEach(key => {
                    this.data.set(key, defaults[key]);
                });

                this.saveToStorage();
                this.log('✨ Datos iniciales creados');
            }

            get(key) {
                return this.data.get(key) || [];
            }

            set(key, value) {
                this.data.set(key, value);
                this.saveToStorage();
                this.log(`💾 ${key} actualizado: ${Array.isArray(value) ? value.length + ' items' : typeof value}`);
            }

            push(key, item) {
                const current = this.get(key);
                current.push(item);
                this.set(key, current);
            }

            saveToStorage() {
                try {
                    const dataToSave = {};
                    this.data.forEach((value, key) => {
                        dataToSave[key] = value;
                    });

                    localStorage.setItem(this.storageKey, JSON.stringify(dataToSave));
                    
                    // Mostrar info de usuarios Google
                    const users = this.get('users');
                    const googleUsers = users.filter(u => u.provider === 'google');
                    if (googleUsers.length > 0) {
                        this.log(`👥 Usuarios Google persistidos: ${googleUsers.length}`);
                    }
                } catch (error) {
                    this.log(`❌ Error guardando: ${error.message}`, 'error');
                }
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const output = document.getElementById('console-output');
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
                output.innerHTML += `<br><span class="${className}">[${timestamp}] ${message}</span>`;
                output.scrollTop = output.scrollHeight;
                
                console.log(`[CASIRA Test] ${message}`);
            }

            getStats() {
                const stats = {};
                this.data.forEach((value, key) => {
                    stats[key] = Array.isArray(value) ? value.length : typeof value;
                });
                return stats;
            }
        }

        // ============= GOOGLE AUTH MANAGER SIMULADO =============
        class TestGoogleAuth {
            constructor() {
                this.isInitialized = false;
                this.currentUser = null;
                this.storage = storage;
            }

            async initialize() {
                return new Promise((resolve) => {
                    if (typeof gapi === 'undefined') {
                        this.storage.log('❌ Google API no disponible', 'error');
                        resolve(false);
                        return;
                    }

                    gapi.load('auth2', async () => {
                        try {
                            const auth2 = await gapi.auth2.init({
                                client_id: '1009348371055-7b2sj5p64g1c8vnkmkrv5v6c0baqhbfq.apps.googleusercontent.com',
                                scope: 'profile email'
                            });

                            this.authInstance = auth2;
                            this.isInitialized = true;

                            // Verificar si ya está autenticado
                            if (auth2.isSignedIn.get()) {
                                const googleUser = auth2.currentUser.get();
                                await this.handleSignIn(googleUser);
                            }

                            this.storage.log('✅ Google Auth inicializado');
                            resolve(true);
                        } catch (error) {
                            this.storage.log(`❌ Error inicializando Google Auth: ${error.message}`, 'error');
                            resolve(false);
                        }
                    });
                });
            }

            async signIn() {
                if (!this.isInitialized) {
                    throw new Error('Google Auth no inicializado');
                }

                try {
                    const googleUser = await this.authInstance.signIn();
                    return await this.handleSignIn(googleUser);
                } catch (error) {
                    this.storage.log(`❌ Error en Google Sign In: ${error.error || error.message}`, 'error');
                    throw error;
                }
            }

            async handleSignIn(googleUser) {
                const profile = googleUser.getBasicProfile();
                
                const userData = {
                    id: profile.getId(),
                    googleId: profile.getId(),
                    email: profile.getEmail(),
                    first_name: profile.getGivenName(),
                    last_name: profile.getFamilyName(),
                    full_name: profile.getName(),
                    avatar_url: profile.getImageUrl(),
                    provider: 'google',
                    role: this.assignRole(profile.getEmail()),
                    created_at: new Date().toISOString(),
                    last_login: new Date().toISOString()
                };

                // Integrar con sistema CASIRA
                await this.integrateWithCASIRA(userData);
                
                this.currentUser = userData;
                this.storage.log(`👤 Usuario Google autenticado: ${userData.email} (${userData.role})`);
                
                return userData;
            }

            async integrateWithCASIRA(googleUserData) {
                const users = this.storage.get('users');
                const existingUser = users.find(u => u.email === googleUserData.email);

                if (existingUser) {
                    // Actualizar usuario existente
                    Object.assign(existingUser, googleUserData);
                    this.storage.set('users', users);
                    this.storage.log(`🔄 Usuario actualizado: ${googleUserData.email}`);
                } else {
                    // Crear nuevo usuario
                    this.storage.push('users', googleUserData);
                    this.storage.log(`🆕 Nuevo usuario Google: ${googleUserData.email}`);
                }
            }

            assignRole(email) {
                if (email.includes('@casira.org')) return 'admin';
                if (email.includes('@volunteer.')) return 'volunteer';
                if (email.includes('@donor.')) return 'donor';
                return 'visitor';
            }

            async signOut() {
                if (this.isInitialized && this.authInstance) {
                    await this.authInstance.signOut();
                    this.currentUser = null;
                    this.storage.log('🚪 Sesión Google cerrada');
                }
            }

            isSignedIn() {
                return this.isInitialized && this.authInstance && this.authInstance.isSignedIn.get();
            }
        }

        // ============= INSTANCIAS GLOBALES =============
        const storage = new TestStorageManager();
        const googleAuth = new TestGoogleAuth();

        // ============= FUNCIONES DE UI =============
        async function initializeTest() {
            updateAuthStatus('Inicializando Google Auth...');
            
            const initialized = await googleAuth.initialize();
            
            if (initialized) {
                if (googleAuth.isSignedIn()) {
                    updateAuthStatus('Autenticado con Google', 'success');
                    showUserInfo(googleAuth.currentUser);
                } else {
                    updateAuthStatus('Google Auth listo - No autenticado', 'info');
                    showSignInButton();
                }
            } else {
                updateAuthStatus('Google Auth no disponible - Modo offline', 'error');
                showSignInButton();
            }
        }

        function updateAuthStatus(message, type = 'info') {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function showUserInfo(user) {
            const userInfoDiv = document.getElementById('user-info');
            const userDetailsDiv = document.getElementById('user-details');
            
            userDetailsDiv.innerHTML = `
                ${user.avatar_url ? `<img src="${user.avatar_url}" class="user-avatar" alt="Avatar">` : ''}
                <div>
                    <h4 style="margin: 0; color: #333;">${user.full_name || user.first_name + ' ' + user.last_name}</h4>
                    <p style="margin: 5px 0; color: #666;">${user.email}</p>
                    <p style="margin: 5px 0; color: #4285F4; font-weight: bold;">Rol: ${user.role}</p>
                    <p style="margin: 5px 0; color: #888; font-size: 12px;">Provider: ${user.provider}</p>
                </div>
            `;
            
            userInfoDiv.classList.add('show');
            document.getElementById('google-signin-btn').style.display = 'none';
        }

        function showSignInButton() {
            document.getElementById('google-signin-btn').style.display = 'inline-block';
            document.getElementById('user-info').classList.remove('show');
        }

        async function signInGoogle() {
            try {
                updateAuthStatus('Autenticando con Google...', 'info');
                const user = await googleAuth.signIn();
                updateAuthStatus('Autenticación exitosa!', 'success');
                showUserInfo(user);
            } catch (error) {
                updateAuthStatus(`Error: ${error.message || 'Error desconocido'}`, 'error');
                showSignInButton();
            }
        }

        async function signOutGoogle() {
            try {
                await googleAuth.signOut();
                updateAuthStatus('Sesión cerrada', 'info');
                showSignInButton();
            } catch (error) {
                storage.log(`❌ Error cerrando sesión: ${error.message}`, 'error');
            }
        }

        function createTestUser() {
            const testUser = {
                id: Date.now(),
                email: `test${Date.now()}@casira.test`,
                first_name: 'Usuario',
                last_name: 'Prueba',
                role: 'visitor',
                provider: 'internal',
                created_at: new Date().toISOString()
            };

            storage.push('users', testUser);
            storage.log(`✅ Usuario de prueba creado: ${testUser.email}`, 'success');
        }

        function listAllUsers() {
            const users = storage.get('users');
            const resultsDiv = document.getElementById('results');
            
            let output = `👥 USUARIOS REGISTRADOS (${users.length}):\n\n`;
            users.forEach((user, index) => {
                output += `${index + 1}. ${user.email}\n`;
                output += `   Nombre: ${user.first_name} ${user.last_name}\n`;
                output += `   Rol: ${user.role}\n`;
                output += `   Provider: ${user.provider}\n`;
                if (user.last_login) output += `   Último login: ${new Date(user.last_login).toLocaleString()}\n`;
                output += '\n';
            });

            resultsDiv.textContent = output;
            resultsDiv.style.display = 'block';
        }

        function showStorageStats() {
            const stats = storage.getStats();
            const resultsDiv = document.getElementById('results');
            
            let output = '📊 ESTADÍSTICAS DE ALMACENAMIENTO:\n\n';
            Object.keys(stats).forEach(key => {
                output += `${key}: ${stats[key]} ${Array.isArray(stats[key]) ? 'items' : ''}\n`;
            });
            
            output += `\n💾 Storage utilizado: ${localStorage.getItem(storage.storageKey)?.length || 0} chars\n`;
            output += `🕒 Última actualización: ${new Date().toLocaleString()}\n`;

            resultsDiv.textContent = output;
            resultsDiv.style.display = 'block';
        }

        function testPersistence() {
            // Agregar datos de prueba
            const testData = {
                id: Date.now(),
                title: 'Test Persistencia',
                content: 'Este es un test de persistencia de datos',
                timestamp: new Date().toISOString()
            };

            storage.push('test_items', testData);
            
            // Simular recarga
            setTimeout(() => {
                const recovered = storage.get('test_items');
                const found = recovered.find(item => item.id === testData.id);
                
                if (found) {
                    storage.log('✅ Test de persistencia EXITOSO: Datos recuperados correctamente', 'success');
                } else {
                    storage.log('❌ Test de persistencia FALLIDO: Datos no encontrados', 'error');
                }
            }, 1000);
        }

        function clearAllStorage() {
            if (confirm('⚠️ ¿Estás seguro de limpiar todos los datos? Esta acción no se puede deshacer.')) {
                localStorage.removeItem(storage.storageKey);
                storage.data.clear();
                storage.initializeDefaults();
                storage.log('🧹 Almacenamiento limpiado y reinicializado', 'success');
                
                // Reset UI
                if (googleAuth.isSignedIn()) {
                    signOutGoogle();
                }
            }
        }

        function simulateActivity() {
            const activity = {
                id: Date.now(),
                title: `Actividad Test ${Math.floor(Math.random() * 1000)}`,
                description: 'Actividad generada para pruebas del sistema',
                created_at: new Date().toISOString(),
                created_by: googleAuth.currentUser?.id || 1
            };

            storage.push('activities', activity);
            storage.log(`🎯 Actividad simulada creada: ${activity.title}`, 'success');
        }

        function testNotifications() {
            const notification = {
                id: Date.now(),
                type: 'test',
                message: 'Notificación de prueba del sistema',
                status: 'pending',
                created_at: new Date().toISOString(),
                user_id: googleAuth.currentUser?.id || 1
            };

            storage.push('notifications', notification);
            storage.log(`🔔 Notificación de prueba creada: ${notification.message}`, 'success');
        }

        function testComments() {
            const comment = {
                id: Date.now(),
                content: 'Este es un comentario de prueba para verificar el sistema de comentarios.',
                user_id: googleAuth.currentUser?.id || 1,
                activity_id: 1,
                created_at: new Date().toISOString()
            };

            storage.push('comments', comment);
            storage.log(`💬 Comentario de prueba creado`, 'success');
        }

        function exportUserData() {
            const allData = {};
            storage.data.forEach((value, key) => {
                allData[key] = value;
            });

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `casira-data-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            storage.log('📤 Datos exportados exitosamente', 'success');
        }

        // ============= INICIALIZACIÓN =============
        window.onload = function() {
            initializeTest();
        };
    </script>
</body>
</html>